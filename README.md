# Описание работы программы!

Программа для распределенного вычисления арифметических выражений, написана на языке Golang. Программа работает на базе данных sqlite. с регистрацией пользователей и сохранением выражений. Для распределенной работы запускается агент, который запускает несколько воркеров и опрашивает сервер на наличие задач. Как только появляется задача, агент обрабатывает ее и возвращает ответ обратно в виде json-файла.  Для работы с программой в первую очередь надо пройти регистрацию в системе, и авторизовать пользователя. После этого можно приступать к выполнению запросов. 

#### Программа работает следующим образом: 
* запуск сервера
* запуск агента
* регистрация пользователя ```http://localhost:8080/api/v1/register.```  
* авторизация пользователя ```http://localhost:8080/api/v1/login.```  
* выполнение запросов ```http://localhost:8080/api/v1/calculate.```  

Запрос на сервер отправляется в виде json-файла: ```{"expression: "...."}```, вместо "...." нужно подставить выражение, например "(2+2)*3-7", ответом на запрос приходит json-файл ```{"id": ...}```, с номером выражения. Номер назначается автоматически.  
Выражение сразу добавляется в БД. Запущенный агент при этом делает запросы на вычисление небольших операций. Как только выражение будет разложено, то в словарь добавляется задание и агент его получает, затем запускает вычисление и отпраляет json-файл с результатом вычисления. Ответ добавляется в map с результатами, после получения окончательного ответа, обновляется база данных.  

#### Запросы к серверу!

Для получения результатов всех выражений надо сделать запрос оркестратору 
```
http://localhost:8080/api/v1/expressions.
```  
Для получения результата одного выражения по ```id```, нужно сделать запрос через командную строку (cmd) 
```
http://localhost:8080/api/v1/expressions/:id
```
вместо ```id``` ставится значение выражения, которое получаете при вводе выражения.  


В программе есть свои тесты для проверки работы по вычислению выражений и http-тесты, для проверки http-запросов.

#### Клонирование репозитория!

```git clone https://github.com/enigmasterr/final_project.git``` - склонировать репозиторий

#### Запуск оркестратора!

зайти в каталог final_project - ```cd final_project```

```go run ./cmd/main.go``` - запуск оркестратора, по умолчанию порт 8080, либо можно получить через переменную окружения

#### Запуск агента! Запустить новую командную строку (cmd)

зайти в каталог final_project/agent - ```cd final_project/agent```

```go run main.go``` - запуск агента, по умолчанию порт 8080, либо можно получить через переменную окружения  

#### Регистрация пользователя

Для регистрации пользователя надо сделать POST-запрос на адрес ```http://localhost:8080/api/v1/register.``` и передать JSON-файл.  
Пример запроса может быть таким:  
```
curl -X POST -H "Content-Type: application/json" -d "{\"login\": \"Dendy\",\"password\": \"pass\"}" http://localhost:8080/api/v1/login
```  
Ответ также возвращается в виде JSON-файла с сообщением об успешной или неудачной регистрации ```{"error": ...} / {"message": ...}```.    

#### Авторизация пользователя

Для авторизации пользователя надо сделать POST-запрос на адрес ```http://localhost:8080/api/v1/login.``` и передать JSON-файл.  
Пример запроса может быть таким:  
```
curl -X POST -H "Content-Type: application/json" -d "{\"login\": \"Dendy\",\"password\": \"pass\"}" http://localhost:8080/api/v1/login
```  
Ответ также возвращается в виде JSON-файла с сообщением об успешной или неудачной регистрации ```{"error": ...} / {"message": ...}```.  

## Схема работы приложения!

Все промежуточные результаты выражения хранятся в срезе Allexpressions - ```[{id1, status1, result1}, {id2, status2, result2}, ...]```  
Все задания агенту находятся в map allTasks ```[id1: {id1, arg1, arg2, op1, op_time1}, id2: ...., ]```  
Все результаты находятся в map allresults ```[{id1: res1}, {id2: res2}, {id2: res2}, ... ]```  
Окончательные результаты выражения записываются в базу данных ```/internal/databade/store.db```  

!Нужно быть в папке с клонированным проектом!

cmd1 -- ```go run cmd/main.go```   - поднимаем сервер(оркестратор)  
cmd2 -- ```go run agent/main.go``` - запускаем агента  
cmd3 -- пишем запросы на вычисление выражения ```curl ...```  



```                                    |---------------|    "internal/task", POST            |---------|```  
```           "api/v1/calculate"       |               |   <---------------------------      |         |```  
```cmd3 ---- отправка выражения -----> |  Оркестратор  |        {id, result}                 |  Агент  |```  
```           {"expression":"..."}     |               |                                     |         |```  
```                                    |               |      "internal/task", GET           |         |```  
```cmd3  <---------------------------  |---------------|   ------------------------------>   |---------|```  
```                {id: ...}                             Task{id, arg1, arg2, oper, op_time}            ```  



```         "api/v1/expressions"         |-------------|```  
```cmd3 <------------------------------> | Оркестратор |```  
```      [{id1, status1, result1}, ...]  |             |```  
```          "api/v1/expressions/:id"    |             |```  
```cmd3 <------------------------------> |-------------|```  
```           {id, status, result}                      ```  


```                    Оркестратор                     ```  
```|--------------------------------------------------|```  
```|              AllExpressions                      |```  
```|                   ^                              |```  
```|                   |                              |```  
```|                   |                              |```  
```|                   |       "getresult/id"         |```  
```|              Allresults --------------> Calc()   |```  
```|                           {id: result}           |```  
```|                                                  |```  
```|                                                  |```  
```|              AllTasks   <------------- Calc()    |```  
```|------------------------------------------------- |```  
 

## Проверка программы на тестах!

запускаем тесты (тесты запускались в windows 11). Необходимо открыть еще одну командную строку (cmd) и отправить тесты ниже:

#### 1. Корректные запросы 
```
curl -X POST -H "Content-Type: application/json" -d "{\"expression\": \"2+2*9\"}" http://localhost:8080/api/v1/calculate
```
Ответ: 200, ```{"result": 18}```

```  
curl -X POST -H "Content-Type: application/json" -d "{\"expression\": \"1/2\"}" http://localhost:8080/api/v1/calculate  
```  
Ответ: 200, ```{"result": 0.5}```  

```  
curl -X POST -H "Content-Type: application/json" -d "{\"expression\": \"(2+3)*9\"}" http://localhost:8080/api/v1/calculate  
```  
Ответ: 200, ```{"result": 36}```  


#### 2. Некорректные запросы
```
curl -X POST -H "Content-Type: application/json" -d "{\"expression\": \"(2+2*9\"}" http://localhost:8080/api/v1/calculate
```

Ответ: 400, ```{"result": 0}```

```
curl -X POST -H "Content-Type: application/json" -d "{\"expression\": \"yy2+2*9\"}" http://localhost:8080/api/v1/calculate
```

Ответ: 422, ```{"result": 0}```

```
curl -X POST -H "Content-Type: application/json" -d "{\"expression\": \"/\"}" http://localhost:8080/api/v1/calculate
```
Ответ: 400, ```{"result": 0}```
```
curl -X GET http://localhost:8080/api/v1/expressions/:999
```
Ответ: 404, ```{"result": 0}```

** Программа логирует запросы и ответы в консоль!

** в папке pkg/calculation/ добавлены http тесты их всего 3

## Запуск тестов

Запустить все тесты в том числе и http, нужно зайти в папку pkg/calculation/ и ввести go test -v

чтобы зайти в папку нужно набрать cd pkg/calculation/
